
<!doctype html>
<html lang="en" class="no-js">
  <head>
    
      <meta charset="utf-8">
      <meta name="viewport" content="width=device-width,initial-scale=1">
      
      
      
        <link rel="canonical" href="https://fightingff.github.io/notebooks/OS/Unit2-Part1/">
      
      
      
      
      <link rel="icon" href="../../assets/images/favicon.png">
      <meta name="generator" content="mkdocs-1.6.0, mkdocs-material-9.5.31">
    
    
      
        <title>U2 Part 1: 同步工具 | Synchronization Tools - FF's Notebooks</title>
      
    
    
      <link rel="stylesheet" href="../../assets/stylesheets/main.3cba04c6.min.css">
      
      


    
    
      
    
    
      
        
        
        <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
        <link rel="stylesheet" href="https://fonts.googleapis.com/css?family=Roboto:300,300i,400,400i,700,700i%7CRoboto+Mono:400,400i,700,700i&display=fallback">
        <style>:root{--md-text-font:"Roboto";--md-code-font:"Roboto Mono"}</style>
      
    
    
      <link rel="stylesheet" href="../../stylesheets/extra.css">
    
      <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.css">
    
    <script>__md_scope=new URL("../..",location),__md_hash=e=>[...e].reduce((e,_)=>(e<<5)-e+_.charCodeAt(0),0),__md_get=(e,_=localStorage,t=__md_scope)=>JSON.parse(_.getItem(t.pathname+"."+e)),__md_set=(e,_,t=localStorage,a=__md_scope)=>{try{t.setItem(a.pathname+"."+e,JSON.stringify(_))}catch(e){}}</script>
    
      

    
    
    
  </head>
  
  
    <body dir="ltr">
  
    
    <input class="md-toggle" data-md-toggle="drawer" type="checkbox" id="__drawer" autocomplete="off">
    <input class="md-toggle" data-md-toggle="search" type="checkbox" id="__search" autocomplete="off">
    <label class="md-overlay" for="__drawer"></label>
    <div data-md-component="skip">
      
        
        <a href="#u2-part-1-synchronization-tools" class="md-skip">
          Skip to content
        </a>
      
    </div>
    <div data-md-component="announce">
      
    </div>
    
    
      

  

<header class="md-header md-header--shadow" data-md-component="header">
  <nav class="md-header__inner md-grid" aria-label="Header">
    <a href="../.." title="FF&#39;s Notebooks" class="md-header__button md-logo" aria-label="FF's Notebooks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    <label class="md-header__button md-icon" for="__drawer">
      
      <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2Z"/></svg>
    </label>
    <div class="md-header__title" data-md-component="header-title">
      <div class="md-header__ellipsis">
        <div class="md-header__topic">
          <span class="md-ellipsis">
            FF's Notebooks
          </span>
        </div>
        <div class="md-header__topic" data-md-component="header-topic">
          <span class="md-ellipsis">
            
              U2 Part 1: 同步工具 | Synchronization Tools
            
          </span>
        </div>
      </div>
    </div>
    
    
      <script>var media,input,key,value,palette=__md_get("__palette");if(palette&&palette.color){"(prefers-color-scheme)"===palette.color.media&&(media=matchMedia("(prefers-color-scheme: light)"),input=document.querySelector(media.matches?"[data-md-color-media='(prefers-color-scheme: light)']":"[data-md-color-media='(prefers-color-scheme: dark)']"),palette.color.media=input.getAttribute("data-md-color-media"),palette.color.scheme=input.getAttribute("data-md-color-scheme"),palette.color.primary=input.getAttribute("data-md-color-primary"),palette.color.accent=input.getAttribute("data-md-color-accent"));for([key,value]of Object.entries(palette.color))document.body.setAttribute("data-md-color-"+key,value)}</script>
    
    
    
      <label class="md-header__button md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
      </label>
      <div class="md-search" data-md-component="search" role="dialog">
  <label class="md-search__overlay" for="__search"></label>
  <div class="md-search__inner" role="search">
    <form class="md-search__form" name="search">
      <input type="text" class="md-search__input" name="query" aria-label="Search" placeholder="Search" autocapitalize="off" autocorrect="off" autocomplete="off" spellcheck="false" data-md-component="search-query" required>
      <label class="md-search__icon md-icon" for="__search">
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0 1 16 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 0 1 9.5 16 6.5 6.5 0 0 1 3 9.5 6.5 6.5 0 0 1 9.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5Z"/></svg>
        
        <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12Z"/></svg>
      </label>
      <nav class="md-search__options" aria-label="Search">
        
        <button type="reset" class="md-search__icon md-icon" title="Clear" aria-label="Clear" tabindex="-1">
          
          <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M19 6.41 17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41Z"/></svg>
        </button>
      </nav>
      
    </form>
    <div class="md-search__output">
      <div class="md-search__scrollwrap" tabindex="0" data-md-scrollfix>
        <div class="md-search-result" data-md-component="search-result">
          <div class="md-search-result__meta">
            Initializing search
          </div>
          <ol class="md-search-result__list" role="presentation"></ol>
        </div>
      </div>
    </div>
  </div>
</div>
    
    
      <div class="md-header__source">
        <a href="https://github.com/fightingff/notebooks" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    fightingff/notebooks
  </div>
</a>
      </div>
    
  </nav>
  
</header>
    
    <div class="md-container" data-md-component="container">
      
      
        
          
        
      
      <main class="md-main" data-md-component="main">
        <div class="md-main__inner md-grid">
          
            
              
              <div class="md-sidebar md-sidebar--primary" data-md-component="sidebar" data-md-type="navigation" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    



<nav class="md-nav md-nav--primary" aria-label="Navigation" data-md-level="0">
  <label class="md-nav__title" for="__drawer">
    <a href="../.." title="FF&#39;s Notebooks" class="md-nav__button md-logo" aria-label="FF's Notebooks" data-md-component="logo">
      
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M12 8a3 3 0 0 0 3-3 3 3 0 0 0-3-3 3 3 0 0 0-3 3 3 3 0 0 0 3 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54Z"/></svg>

    </a>
    FF's Notebooks
  </label>
  
    <div class="md-nav__source">
      <a href="https://github.com/fightingff/notebooks" title="Go to repository" class="md-source" data-md-component="source">
  <div class="md-source__icon md-icon">
    
    <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 448 512"><!--! Font Awesome Free 6.6.0 by @fontawesome - https://fontawesome.com License - https://fontawesome.com/license/free (Icons: CC BY 4.0, Fonts: SIL OFL 1.1, Code: MIT License) Copyright 2024 Fonticons, Inc.--><path d="M439.55 236.05 244 40.45a28.87 28.87 0 0 0-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 0 1-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 0 0 0 40.81l195.61 195.6a28.86 28.86 0 0 0 40.8 0l194.69-194.69a28.86 28.86 0 0 0 0-40.81z"/></svg>
  </div>
  <div class="md-source__repository">
    fightingff/notebooks
  </div>
</a>
    </div>
  
  <ul class="md-nav__list" data-md-scrollfix>
    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="../.." class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Home
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    <li class="md-nav__item">
      <a href="https://isshikihugh.github.io/zju-cs-asio/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ZJU CS Masters' Notes
  </span>
  

      </a>
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3" >
        
          
          <label class="md-nav__link" for="__nav_3" id="__nav_3_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Courses
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3">
            <span class="md-nav__icon md-icon"></span>
            Courses
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_1" >
        
          
          <label class="md-nav__link" for="__nav_3_1" id="__nav_3_1_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    大一
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_1_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_1">
            <span class="md-nav__icon md-icon"></span>
            大一
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ASM/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    x86 Asm
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_2" >
        
          
          <label class="md-nav__link" for="__nav_3_2" id="__nav_3_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    大二上
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_2">
            <span class="md-nav__icon md-icon"></span>
            大二上
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../DigitLogic/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Digit Logic Design
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CS231n/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    CS 231n
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3" >
        
          
          <label class="md-nav__link" for="__nav_3_3" id="__nav_3_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    大二下
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3">
            <span class="md-nav__icon md-icon"></span>
            大二下
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../ADS/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    ADS
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../OOP/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    OOP
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Info/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Information Theory
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Database/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Database
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../RiscV/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Computer Organization
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_3_6" >
        
          
          <label class="md-nav__link" for="__nav_3_3_6" id="__nav_3_3_6_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    UCB-Sysadmin DeCal
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_3_6_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_3_6">
            <span class="md-nav__icon md-icon"></span>
            UCB-Sysadmin DeCal
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../SD/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Course Notes
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Bandit/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Bandit for fun
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4" >
        
          
          <label class="md-nav__link" for="__nav_3_4" id="__nav_3_4_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    大三上
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="2" aria-labelledby="__nav_3_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4">
            <span class="md-nav__icon md-icon"></span>
            大三上
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../CA/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Computer Architecture
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_2" >
        
          
          <label class="md-nav__link" for="__nav_3_4_2" id="__nav_3_4_2_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Network
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_2_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_2">
            <span class="md-nav__icon md-icon"></span>
            Network
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network/Network1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network/Network2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Physical Layer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network/Network3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Data Link Layer
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Network/Network4/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Network Layer
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
              
                
  
  
  
  
    
    
    
      
    
    
    <li class="md-nav__item md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_3_4_3" >
        
          
          <label class="md-nav__link" for="__nav_3_4_3" id="__nav_3_4_3_label" tabindex="0">
            
  
  <span class="md-ellipsis">
    Operating System
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="3" aria-labelledby="__nav_3_4_3_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_3_4_3">
            <span class="md-nav__icon md-icon"></span>
            Operating System
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../OS1/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Overview
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../OS2/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Process
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../OS3/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Memory
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_4" >
        
          
          <label class="md-nav__link" for="__nav_4" id="__nav_4_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Tools
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_4_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_4">
            <span class="md-nav__icon md-icon"></span>
            Tools
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Git/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Git
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Make/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Makefile & CMake
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../Vim/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    Vim
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
      
      
  
  
  
  
    
    
    
      
        
        
      
    
    
    <li class="md-nav__item md-nav__item--section md-nav__item--nested">
      
        
        
        <input class="md-nav__toggle md-toggle " type="checkbox" id="__nav_5" >
        
          
          <label class="md-nav__link" for="__nav_5" id="__nav_5_label" tabindex="">
            
  
  <span class="md-ellipsis">
    Materials
  </span>
  

            <span class="md-nav__icon md-icon"></span>
          </label>
        
        <nav class="md-nav" data-md-level="1" aria-labelledby="__nav_5_label" aria-expanded="false">
          <label class="md-nav__title" for="__nav_5">
            <span class="md-nav__icon md-icon"></span>
            Materials
          </label>
          <ul class="md-nav__list" data-md-scrollfix>
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="../../AI_Materials/" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    AI Materials
  </span>
  

      </a>
    </li>
  

              
            
              
                
  
  
  
  
    <li class="md-nav__item">
      <a href="https://github.com/fightingff/AI" class="md-nav__link">
        
  
  <span class="md-ellipsis">
    My AI Repository
  </span>
  

      </a>
    </li>
  

              
            
          </ul>
        </nav>
      
    </li>
  

    
  </ul>
</nav>
                  </div>
                </div>
              </div>
            
            
              
              <div class="md-sidebar md-sidebar--secondary" data-md-component="sidebar" data-md-type="toc" >
                <div class="md-sidebar__scrollwrap">
                  <div class="md-sidebar__inner">
                    

<nav class="md-nav md-nav--secondary" aria-label="Table of contents">
  
  
  
    
  
  
    <label class="md-nav__title" for="__toc">
      <span class="md-nav__icon md-icon"></span>
      Table of contents
    </label>
    <ul class="md-nav__list" data-md-component="toc" data-md-scrollfix>
      
        <li class="md-nav__item">
  <a href="#_1" class="md-nav__link">
    <span class="md-ellipsis">
      竞态条件
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#the-critical-section-problem" class="md-nav__link">
    <span class="md-ellipsis">
      The Critical-Section Problem
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#for-kernel-code" class="md-nav__link">
    <span class="md-ellipsis">
      For Kernel Code
    </span>
  </a>
  
    <nav class="md-nav" aria-label="For Kernel Code">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#petersons-algorithm" class="md-nav__link">
    <span class="md-ellipsis">
      Peterson’s Algorithm
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_2" class="md-nav__link">
    <span class="md-ellipsis">
      算法描述
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_3" class="md-nav__link">
    <span class="md-ellipsis">
      性质证明
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#memory-barriers" class="md-nav__link">
    <span class="md-ellipsis">
      Memory Barriers
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#hardware-instructions" class="md-nav__link">
    <span class="md-ellipsis">
      Hardware Instructions
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Hardware Instructions">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#test_and_set" class="md-nav__link">
    <span class="md-ellipsis">
      test_and_set()
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#compare_and_swap" class="md-nav__link">
    <span class="md-ellipsis">
      compare_and_swap()
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#atomic-variables" class="md-nav__link">
    <span class="md-ellipsis">
      Atomic Variables
    </span>
  </a>
  
</li>
      
        <li class="md-nav__item">
  <a href="#mutex-locks" class="md-nav__link">
    <span class="md-ellipsis">
      Mutex Locks
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Mutex Locks">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_4" class="md-nav__link">
    <span class="md-ellipsis">
      忙等待
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
        <li class="md-nav__item">
  <a href="#semaphores" class="md-nav__link">
    <span class="md-ellipsis">
      Semaphores
    </span>
  </a>
  
    <nav class="md-nav" aria-label="Semaphores">
      <ul class="md-nav__list">
        
          <li class="md-nav__item">
  <a href="#_5" class="md-nav__link">
    <span class="md-ellipsis">
      使用
    </span>
  </a>
  
</li>
        
          <li class="md-nav__item">
  <a href="#_6" class="md-nav__link">
    <span class="md-ellipsis">
      避免忙等待
    </span>
  </a>
  
</li>
        
      </ul>
    </nav>
  
</li>
      
    </ul>
  
</nav>
                  </div>
                </div>
              </div>
            
          
          
            <div class="md-content" data-md-component="content">
              <article class="md-content__inner md-typeset">
                
                  

  
  


<h1 id="u2-part-1-synchronization-tools">U2 Part 1: 同步工具 | Synchronization Tools</h1>
<div class="admonition info">
<p class="admonition-title">引入</p>
<blockquote>
<p>首先我们<strong>简单</strong>描述什么是同步问题，读者可以抱着对下面这段话的疑问去阅读接下来的内容。</p>
<p>不必尝试立刻理解这段话，我希望读者能够在看的过程中以下面这段话为主线，猜测接下来将要展开的内容，去发现问题、思考解决办法。</p>
</blockquote>
<p>在支持并发甚至并行的系统中，虽然进程之间相对隔离，在一般情况下互不<strong>直接</strong>干扰，都是自顾自跑。即，是异步的。但由于<strong>各些原因</strong>（例如都需要对一共享资源的修改），进程之间的执行需要互相制约，遵循特定的先后顺序，因此进程需要通过<strong>某些手段</strong>，让协作进程能够直接或间接了解到其它相关进程的状态，以实现对当前进程执行的控制，最终在宏观上实现一种“同步”。</p>
<p>而上面提到的“<strong>各种原因</strong>”和“<strong>某些手段</strong>”，就是我们稍后将讨论的东西。其中，这里的“<strong>某些手段</strong>”，就是指我们的各种同步工具。</p>
<p>需要注意的是，同步并不是某种中心化的调控机制，而更像是一种“协议”：当各个进程发现有别的进程与自己产生竞争时，应当有某种手段允许它们达成协商，以决定谁先谁后。</p>
<p>我们按照问题的复杂程度，由浅入深地讨论这些东西。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">语境问题</p>
<p>一个比较尴尬的问题是，书本上以协作进程的语境为开篇，但接下来讲的有些内容是以线程同步为语境（对于这个问题我已经放弃去梳理和纠正书中的措辞了，累了），如果在用词上都区分线程和进程，那么会变得很繁杂，所以我接下来一律用进程表示，但读者心中应当对这个语境更适于线程还是进程有所感受。</p>
<p>关于这些方法更适合在 process 还是 thread 上被应用，可以看<a href="https://stackoverflow.com/a/4623428/22331129" target="_blank">这个</a>。</p>
</div>
<h2 id="_1">竞态条件</h2>
<div class="admonition quote">
<p class="admonition-title">Links</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Race_condition" target="_blank">Race Condition | Wikipedia</a></li>
</ul>
</div>
<p>我们需要意识到，我们无法一步到位地、in-place 地去修改一个内存中的数据。换言之，要想修改 <code>mem[x]</code>，我们需要三个步骤：</p>
<ol>
<li><code>reg</code> &lt;- <code>mem[x]</code>；</li>
<li><code>reg</code> &lt;- update(<code>reg</code>)；</li>
<li><code>mem[x]</code> &lt;- <code>reg</code>；</li>
</ol>
<p>而如果现在不止一个进程在修改 <code>mem[x]</code>，例如下面这个例子：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-0-1">1</a></span>
<span class="normal"><a href="#__codelineno-0-2">2</a></span>
<span class="normal"><a href="#__codelineno-0-3">3</a></span>
<span class="normal"><a href="#__codelineno-0-4">4</a></span>
<span class="normal"><a href="#__codelineno-0-5">5</a></span>
<span class="normal"><a href="#__codelineno-0-6">6</a></span>
<span class="normal"><a href="#__codelineno-0-7">7</a></span>
<span class="normal"><a href="#__codelineno-0-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-0-1" name="__codelineno-0-1"></a>┌──────────────┬──────────────┐
<a id="__codelineno-0-2" name="__codelineno-0-2"></a>│ process A    │ process B    │ mem[x] = 1 (initial)
<a id="__codelineno-0-3" name="__codelineno-0-3"></a>├──────────────┼──────────────┤
<a id="__codelineno-0-4" name="__codelineno-0-4"></a>│ t0 &lt;- mem[x] │ t0 &lt;- mem[x] │ mem[x] = 1
<a id="__codelineno-0-5" name="__codelineno-0-5"></a>│ t0 &lt;- t0 + 1 │ t0 &lt;- t0 + 1 │
<a id="__codelineno-0-6" name="__codelineno-0-6"></a>│ mem[x] &lt;- t0 │ t0 &lt;- t0 + 1 │ mem[x] = 2, B&#39;s t0 is out of date
<a id="__codelineno-0-7" name="__codelineno-0-7"></a>│              │ mem[x] &lt;- t0 │ mem[x] = 3, 2 is overwritten
<a id="__codelineno-0-8" name="__codelineno-0-8"></a>└──────────────┴──────────────┘
</code></pre></div></td></tr></table></div>
<p>它们都想要更新 <code>mem[x]</code>，又好巧不巧的它们几乎同时发生读取了 <code>mem[x]</code>，那么就会出现问题：两个进程同时读取 <code>mem[x]</code>，然后各自计算更新后的值，然后各自写回 <code>mem[x]</code>；理想情况下，最终的 <code>mem[x]</code> 会比原来大 3；但现在的 <code>mem[x]</code> 只比原来大 2，其中 process A 对它的修改在第 7 行被覆盖了。</p>
<p>究其根本，由于我们处在并发语境下，所以会出现若干用户同时持有一份数据资源的情况（为了发挥并发的优势，我们也应当尽可能的满足这种需求），逻辑上数据修改过程应当是符号的、瞬间的、立即生效的；但实际上我们对数据的操作是数值的、需要一段时间来完成的。在这种（后者）语境下，<u>如果读入数值完成到写入数值完成的过程中，<code>mem[x]</code> 发生变化</u>，那么该操作实际上是使用过时数据进行计算。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-1-1">1</a></span>
<span class="normal"><a href="#__codelineno-1-2">2</a></span>
<span class="normal"><a href="#__codelineno-1-3">3</a></span>
<span class="normal"><a href="#__codelineno-1-4">4</a></span>
<span class="normal"><a href="#__codelineno-1-5">5</a></span>
<span class="normal"><a href="#__codelineno-1-6">6</a></span>
<span class="normal"><a href="#__codelineno-1-7">7</a></span>
<span class="normal"><a href="#__codelineno-1-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-1-1" name="__codelineno-1-1"></a>┌──────────────┬──────────────┐
<a id="__codelineno-1-2" name="__codelineno-1-2"></a>│ process A    │ process B    │ mem[x] = 1 (initial)
<a id="__codelineno-1-3" name="__codelineno-1-3"></a>├──────────────┼──────────────┤
<a id="__codelineno-1-4" name="__codelineno-1-4"></a>│ t0 &lt;- mem[x] │ t0 &lt;- mem[x] │ mem[x] = 1
<a id="__codelineno-1-5" name="__codelineno-1-5"></a>│ t0 &lt;- t0 + 1 │ t0 &lt;- t0 + 1 │
<a id="__codelineno-1-6" name="__codelineno-1-6"></a><span class="hll">│ mem[x] &lt;- t0 │ t0 &lt;- t0 + 1 │ mem[x] = 2, B&#39;s t0 is out of date
</span><a id="__codelineno-1-7" name="__codelineno-1-7"></a>│              │ mem[x] &lt;- t0 │ mem[x] = 3, 2 is overwritten
<a id="__codelineno-1-8" name="__codelineno-1-8"></a>└──────────────┴──────────────┘
</code></pre></div></td></tr></table></div>
<p>可以发现，第六行的 <code>t0</code> 仍然在用被 process A 更新之前的 <code>mem[x]</code> 做计算，因而可以认为此时 process B 中 <code>t0</code> 参与运算的、暗含的 <code>mem[x]</code> 的数据已经<strong>过时</strong>。</p>
<div class="admonition definition">
<p class="admonition-title">race condition</p>
<p>类似这种的，由两个信号产生竞争，其竞争情况影响最终结果的情况，被称为<strong>竞态条件(race condition)</strong>。在上面这个例子中，谁后执行，最终结果就是谁的输出，而另一个用户的输出则会被覆盖。</p>
<p>需要注意的是，我们对竞态条件的看法并不应该是“如何控制竞争结果”，因为无论竞争结果如何（甚至谁赢了结果可能都一样），只要这种“竞争”出现，那么最终结果就有可能不符合预期的。就比如上面的例子，无论最终 <code>mem[x]</code> 是 3 还是 2 都不对，理想情况下应该是 4——无论是先进行 <code>+1</code> 还是先进行 <code>+2</code>。</p>
<p>我们真正需要关注的重点应该是如何<strong>避免这种竞争</strong>的出现。</p>
</div>
<div class="admonition warning">
<p class="admonition-title">注意</p>
<p>虽然上面的例子中我们模拟的两个程序是按照相同速度，一行一个指令执行的，但是我们在并行语境下对所有进程执行的速度不应当有所假设，即进程 A 不知道进程 B 的速度。</p>
<p>不仅如此，我们也并不一定要在并行语境下讨论这个问题，在多道语境下这个问题都会出现，例如：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-2-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-2-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-2-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-2-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-2-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-2-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-2-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-2-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-2-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-2-10">10</a></span>
<span class="normal"><a href="#__codelineno-2-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-2-1" name="__codelineno-2-1"></a>┌──────────────┐     ┌──────────────┐
<a id="__codelineno-2-2" name="__codelineno-2-2"></a>│ process A    │     │ process B    │ mem[x] = 1 (initial)
<a id="__codelineno-2-3" name="__codelineno-2-3"></a>├──────────────┤     ├──────────────┤
<a id="__codelineno-2-4" name="__codelineno-2-4"></a>│              │     │ t0 &lt;- mem[x] │ mem[x] = 1
<a id="__codelineno-2-5" name="__codelineno-2-5"></a>│ t0 &lt;- mem[x] │◄────┤ &lt;ctx switch&gt; │ mem[x] = 1
<a id="__codelineno-2-6" name="__codelineno-2-6"></a>│ t0 &lt;- t0 + 1 │     │              │
<a id="__codelineno-2-7" name="__codelineno-2-7"></a>│ mem[x] &lt;- t0 │     │              │ mem[x] = 2, B&#39;s t0 is out of date
<a id="__codelineno-2-8" name="__codelineno-2-8"></a>│ &lt;ctx switch&gt; ├────►│ t0 &lt;- t0 + 1 │
<a id="__codelineno-2-9" name="__codelineno-2-9"></a>│              │     │ t0 &lt;- t0 + 1 │ 
<a id="__codelineno-2-10" name="__codelineno-2-10"></a>│              │     │ mem[x] &lt;- t0 │ mem[x] = 3, 2 is overwritten
<a id="__codelineno-2-11" name="__codelineno-2-11"></a>└──────────────┘     └──────────────┘
</code></pre></div></td></tr></table></div>
<p>问题依旧。</p>
</div>
<p>根据上面这个具体的例子，我们发现，如果需要解决这个问题，我们有两种选择：</p>
<ol>
<li>进行符号的运算而非数值的运算，这样输入的变化能在任意时刻反映在输出上，这样时时刻刻都是“最新”，而不会出现“过时”；</li>
<li>保证读入数值完成到写入数值完成的过程中，<code>mem[x]</code> 保持不变，即两个可能竞争的操作，在时间上不应该有交集；</li>
</ol>
<p>显然，我们应当选择第二种。</p>
<h2 id="the-critical-section-problem">The Critical-Section Problem</h2>
<p>为了更好地展开，我们对上面的这种情况进行建模，并给出解决 race condition 问题的方法需要满足的范式：</p>
<p>我们应当保证在一个进程在修改 <code>mem[x]</code> 的时候，其它进程不应该读取 <code>mem[x]</code>（至少不应以修改 <code>mem[x]</code> 为目的来读取），直到这个进程完成对 <code>mem[x]</code> 的修改。换句话来说，<code>mem[x]</code> 这个共享资源应当只能被一个用户持有，我们称这种只能被至多一个用户占有的资源为临界资源。而程序中访问临界资源的代码段，我们称之为<strong>临界区段(critical section, CS)^<a href="https://en.wikipedia.org/wiki/Critical_section" target="_blank">Wiki</a>^</strong>。</p>
<p>那么，对于之前提到过的例子，我们拿出来对比模拟的部分就是 critical section。</p>
<p>而 CS 问题，指的就是<u>如何保证最多只有一个用户在执行临界区段的代码</u>[^1]。</p>
<hr />
<p>围绕临界区段，我们定义能够解决 CS 问题的代码应当能够做如下划分：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-3-1" name="__codelineno-3-1" href="#__codelineno-3-1"></a>┌─────────────────────┐
<a id="__codelineno-3-2" name="__codelineno-3-2" href="#__codelineno-3-2"></a>│  Entry Section      │ &lt;-- ask for &amp; wait for permission to enter CS
<a id="__codelineno-3-3" name="__codelineno-3-3" href="#__codelineno-3-3"></a>├─────────────────────┤
<a id="__codelineno-3-4" name="__codelineno-3-4" href="#__codelineno-3-4"></a>│  Critical Section   │ &lt;-- codes manipulating critical resources
<a id="__codelineno-3-5" name="__codelineno-3-5" href="#__codelineno-3-5"></a>├─────────────────────┤
<a id="__codelineno-3-6" name="__codelineno-3-6" href="#__codelineno-3-6"></a>│  Exit Section       │ &lt;-- release the critical resources
<a id="__codelineno-3-7" name="__codelineno-3-7" href="#__codelineno-3-7"></a>├─────────────────────┤
<a id="__codelineno-3-8" name="__codelineno-3-8" href="#__codelineno-3-8"></a>│  Remainder Section  │ &lt;-- other codes
<a id="__codelineno-3-9" name="__codelineno-3-9" href="#__codelineno-3-9"></a>└─────────────────────┘
</code></pre></div>
<p>进程需要在 entry section 判断是否能够进入 critical section，即索取临界资源，如果不行则等待；而在进入 critical section 后，进程需要在 exit section 释放临界资源；然后脱离 CS 问题的语境，进入 remainder section 继续执行。</p>
<p>同时，我们要求解决方案需要满足如下性质：</p>
<p><a id="r4s2csp"></a></p>
<div class="admonition definition">
<p class="admonition-title">requirements for solution to CS problem</p>
<ol>
<li>临界互斥(mutual exclusion)：操作同一临界资源的临界区段应当互相排斥；<ul>
<li>如果进程 <span class="arithmatex">\(P_i\)</span> 正在执行其 critical section，那么不应当有其他进程处于（操作同一临界资源的）critical section；</li>
</ul>
</li>
<li>选择时间有限(progress)：选择下一个进入 critical section 的操作应当只有处于 entry/critical/exit section 的进程参与，且该选择应当在<strong>有限时间内被执行</strong>；</li>
<li>等待时间有限(bounded waiting)：进程等待被允许进入 critical section 的时间应当是有限的；</li>
</ol>
</div>
<p>接下来，我们以讨论 CS 问题是如何解决的为主线，探索如何解决 race condition。</p>
<div class="admonition tip">
<p class="admonition-title">头脑风暴</p>
<p>整个过程有点像<a href="./Unit1.md/#进程调度" target="_bank">调度</a>，等待临界资源的过程就好像 ready 态等待调度过程中的 CPU 资源（CPU 也可以认为是一种临界资源，只不过它不是由进程主动处理和索取）。</p>
<p>既然如此我们可以迁移“状态”这个概念。我们只关心直接与 CS 问题有关的状态，所以我在这里定义：就绪、临界、无关三个状态。</p>
<ol>
<li>就绪态：进程随时准备好进入 critical section，<u><strong>想要</strong>持有临界资源</u>；</li>
<li>临界态：进程正在执行 critical section，<u><strong>持有</strong>临界资源</u>，或进程执行完 critical section，执行 exit section <u>正在释放<strong>持有</strong>的临界资源中</u>；</li>
<li>无关态：不处于就绪态也不处于临界态，不想要持有临界资源，或是使用完已经释放；</li>
</ol>
<p>根据我们先前给出的，解法<a href="#r4s2csp" target="_blank">需要满足的性质</a>中的 mutual exclusion，不能同时有多个进程处于临界态，但是可以有若干进程处于就绪态，而无关态则表示不会产生竞争，和调度过程十分相似。</p>
<p>这些定义将会在我们之后的探索中起作用。</p>
</div>
<h2 id="for-kernel-code">For Kernel Code</h2>
<p>由于 kernel code 下的 CS 问题解决较为清晰直接，所以先行介绍。</p>
<div class="admonition section">
<p class="admonition-title">For Kernel Code</p>
<p>在 kernel code 中也普遍存在着 race condition 的问题，例如：</p>
<p><figure markdown>
<center> <img alt="Race condition when assigning a pid." src="../img/22.png" /> </center>
Race condition when assigning a pid.
</figure></p>
<p>上例中 <span class="arithmatex">\(P_0\)</span> 和 <span class="arithmatex">\(P_1\)</span> 同时访问了 <code>next_available_pid</code> 这个临界资源，产生竞争，导致最后有两个进程使用了同一个 <code>pid</code>。</p>
<p>欲解决 kernel code 中的 CS 问题，我们可以保证只有一个进程可以运行在 kernel mode，这样就可以保证在 kernel code 中访问临界资源的行为，从而解决 CS 问题。</p>
<p>对于单处理器来说，我们只需要在 kernel code 中禁止中断，就可以保证只有一个进程可以运行在 kernel mode；而对于多处理器来说，这种方法就不那么合适了——我们需要同时告诉多个处理器中断被禁止，而这个过程中的时延仍然会产生问题；不仅如此，这个方法也会带来额外的开销。在多处理器语境下，我们需要实现<strong>抢占式内核(preemptive kernels)</strong>和<strong>非抢占式内核(non-preemptive kernels)</strong>，关键是后者实现了一段时间内只有一个进程可以运行在 kernel mode[^2]。</p>
</div>
<p>接下来我们探索更为通用的解决方案。</p>
<div class="admonition info">
<p class="admonition-title">说明</p>
<p>为了简化说明代码，我们用全大写来表示一个共享资源，例如 <code>READY</code>，它能够被若干进程访问。实际上这个功能应当由操作系统提供，并不是我们关注的重点。</p>
</div>
<h3 id="petersons-algorithm">Peterson’s Algorithm</h3>
<div class="admonition quote">
<p class="admonition-title">Links</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Peterson%27s_algorithm">Peterson's algorithm | Wikipedia</a></li>
</ul>
</div>
<p>Peterson's algorithm 是对<strong>只有两个进程参与</strong>的同步问题的一个解法，具有一定的局限性，但其设计相对简单，所以先行给出。在本节中，我们假设 <span class="arithmatex">\(P_0\)</span> 和 <span class="arithmatex">\(P_1\)</span> 是参与同步问题讨论的两个进程。</p>
<blockquote>
<p>基于 Peterson's algorithm 对多进程情况的扩展被称为 <a href="https://en.wikipedia.org/wiki/Peterson%27s_algorithm#Filter_algorithm:_Peterson's_algorithm_for_more_than_two_processes" target="_blank">filter algorithm</a>，但 filter algorithm 不满足 bounded waiting time 的条件，读者有兴趣可以自行了解。</p>
</blockquote>
<h3 id="_2">算法描述</h3>
<p>为了保证处于临界态的进程至多只有一个，我们应当在进程处于就绪态时，确认没有其他进程处于临界态后再进入。其中最重要的一件事就是，当我们处在 <span class="arithmatex">\(P_0\)</span> 时，我们如何知道 <span class="arithmatex">\(P_1\)</span> 是否正处于临界态呢？Peterson’s Algorithm 通过如下方式实现了这件事：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-4-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-4-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-4-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-4-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-4-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-4-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-4-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-4-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-4-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-4-10">10</a></span>
<span class="normal"><a href="#__codelineno-4-11">11</a></span>
<span class="normal"><a href="#__codelineno-4-12">12</a></span>
<span class="normal"><a href="#__codelineno-4-13">13</a></span>
<span class="normal"><a href="#__codelineno-4-14">14</a></span>
<span class="normal"><a href="#__codelineno-4-15">15</a></span>
<span class="normal"><a href="#__codelineno-4-16">16</a></span>
<span class="normal"><a href="#__codelineno-4-17">17</a></span>
<span class="normal"><a href="#__codelineno-4-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-4-1" name="__codelineno-4-1"></a><span class="c1">// `i` is 0 or 1, indicating current pid, while `j` is another pid.</span>
<a id="__codelineno-4-2" name="__codelineno-4-2"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-4-3" name="__codelineno-4-3"></a><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-4-4" name="__codelineno-4-4"></a>
<a id="__codelineno-4-5" name="__codelineno-4-5"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">                    </span><span class="c1">// ┐</span>
<a id="__codelineno-4-6" name="__codelineno-4-6"></a><span class="w">    </span><span class="n">TURN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w">                           </span><span class="c1">// │</span>
<a id="__codelineno-4-7" name="__codelineno-4-7"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="c1">// ├ entry section</span>
<a id="__codelineno-4-8" name="__codelineno-4-8"></a><span class="w">        </span><span class="c1">// i.e. wait until:             // │</span>
<a id="__codelineno-4-9" name="__codelineno-4-9"></a><span class="w">        </span><span class="c1">//  (1) j exits,                // │</span>
<a id="__codelineno-4-10" name="__codelineno-4-10"></a><span class="w">        </span><span class="c1">//  (2) j is slower, so it      // │</span>
<a id="__codelineno-4-11" name="__codelineno-4-11"></a><span class="w">        </span><span class="c1">//      should run now.         // ┘</span>
<a id="__codelineno-4-12" name="__codelineno-4-12"></a>
<a id="__codelineno-4-13" name="__codelineno-4-13"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">    </span><span class="c1">// - critical section</span>
<a id="__codelineno-4-14" name="__codelineno-4-14"></a>
<a id="__codelineno-4-15" name="__codelineno-4-15"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                   </span><span class="c1">// - exit section</span>
<a id="__codelineno-4-16" name="__codelineno-4-16"></a>
<a id="__codelineno-4-17" name="__codelineno-4-17"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                  </span><span class="c1">// - remainder section</span>
<a id="__codelineno-4-18" name="__codelineno-4-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<blockquote>
<p>首先说明，entry section 没有临界资源，这里的 <code>TURN</code> 是我们故意放在这里的。</p>
</blockquote>
<p><code>READY</code> 是一个共享的数组，每个进程只修改与自己一一对应的 element，所以本质上 <code>READY</code> 不会出现 race condition，因而也不是临界资源。而 <code>TURN</code>，我们在第 6 行只对 <code>TURN</code> 进行直接写的操作，但是 P1 和 P2 谁后跑完到这一行会决定 <code>TURN</code> 最后的值，所以实际上这里有 race condition。</p>
<p>但这就是 Peterson’s Algorithm 巧妙的地方，Peterson's 利用 race condition 这个“后覆盖前”的性质，实现了标记了这两个进程的先来后到的效果。我们都向这个 <code>TURN</code> 写一个独特的值（比如自己的 id，或者对方的 id），等大家都写好后我们看看这个值最终是谁写的，于是就知道谁后到。</p>
<p>利用这个原理，Peterson's 这里做了一个“非常有中国人气质”的事情：<span class="arithmatex">\(P_0\)</span> 和 <span class="arithmatex">\(P_1\)</span> 上公交车后同时看上了一个座位，<span class="arithmatex">\(P_0\)</span> 说：“你坐吧。”， <span class="arithmatex">\(P_1\)</span> 自然也要客气一下，说：“还是你坐吧！”。现在两边都客气过了，<span class="arithmatex">\(P_0\)</span> 就可以心安理得地坐下了。对上述过程，我们给出 <span class="arithmatex">\(P_0\)</span> 获得椅子的准确条件有：</p>
<ol>
<li><span class="arithmatex">\(P_0\)</span> 想坐下，<span class="arithmatex">\(P_1\)</span> 也想坐下（否则就没有冲突，可以直接坐下了）；</li>
<li><span class="arithmatex">\(P_0\)</span> 发现 <span class="arithmatex">\(P_1\)</span> 在客气，但 <span class="arithmatex">\(P_0\)</span> <strong>已经</strong>客气过了；</li>
</ol>
<p>对应到上面给出的代码里，这个条件可以翻译为：</p>
<ol>
<li><code class="highlight"><span class="n">READY</span><span class="p">[</span><span class="mi">0</span><span class="p">]</span></code> = <code class="highlight"><span class="n">READY</span><span class="p">[</span><span class="mi">1</span><span class="p">]</span></code> = <code class="highlight"><span class="nb">true</span></code>；</li>
<li><code class="highlight"><span class="n">TURN</span></code> ≠ <code>j</code>，但此前 <span class="arithmatex">\(P_i\)</span> 已经执行过 <code>TURN &lt;- j</code>；</li>
</ol>
<div class="admonition advice">
<p class="admonition-title">请读者仔细思考上面的过程，并适当进行全面的模拟以理解 Peterson's 是如何工作的。</p>
</div>
<h3 id="_3">性质证明</h3>
<p>现在我们需要证明这个算法满足<a href="#r4s2csp" target="_blank">性质</a>。</p>
<blockquote>
<p>我的证明比较详细和啰嗦，但我认为完整地模拟更加有利于直觉理解，如果你想要更简洁的证明，可以参考 <a href="https://xuan-insr.github.io/%E6%A0%B8%E5%BF%83%E7%9F%A5%E8%AF%86/os/III_process_sync/6_sync_tools/#%E6%80%A7%E8%B4%A8%E8%AF%81%E6%98%8E" target="_blank">xyx 的笔记</a>。</p>
</blockquote>
<details class="proof">
<summary>mutual exclusion</summary>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-5-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-5-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-5-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-5-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-5-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-5-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-5-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-5-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-5-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-5-10">10</a></span>
<span class="normal"><a href="#__codelineno-5-11">11</a></span>
<span class="normal"><a href="#__codelineno-5-12">12</a></span>
<span class="normal"><a href="#__codelineno-5-13">13</a></span>
<span class="normal"><a href="#__codelineno-5-14">14</a></span>
<span class="normal"><a href="#__codelineno-5-15">15</a></span>
<span class="normal"><a href="#__codelineno-5-16">16</a></span>
<span class="normal"><a href="#__codelineno-5-17">17</a></span>
<span class="normal"><a href="#__codelineno-5-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-5-1" name="__codelineno-5-1"></a><span class="c1">// `i` is 0 or 1, indicating current pid, while `j` is another pid.</span>
<a id="__codelineno-5-2" name="__codelineno-5-2"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-5-3" name="__codelineno-5-3"></a><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-5-4" name="__codelineno-5-4"></a>
<a id="__codelineno-5-5" name="__codelineno-5-5"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">                    </span><span class="c1">// ┐</span>
<a id="__codelineno-5-6" name="__codelineno-5-6"></a><span class="w">    </span><span class="n">TURN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w">                           </span><span class="c1">// │</span>
<a id="__codelineno-5-7" name="__codelineno-5-7"></a><span class="hll"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="c1">// ├ entry section</span>
</span><a id="__codelineno-5-8" name="__codelineno-5-8"></a><span class="w">        </span><span class="c1">// i.e. wait until:             // │</span>
<a id="__codelineno-5-9" name="__codelineno-5-9"></a><span class="w">        </span><span class="c1">//  (1) j exits,                // │</span>
<a id="__codelineno-5-10" name="__codelineno-5-10"></a><span class="w">        </span><span class="c1">//  (2) j is slower, so it      // │</span>
<a id="__codelineno-5-11" name="__codelineno-5-11"></a><span class="w">        </span><span class="c1">//      should run now.         // ┘</span>
<a id="__codelineno-5-12" name="__codelineno-5-12"></a>
<a id="__codelineno-5-13" name="__codelineno-5-13"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">    </span><span class="c1">// - critical section</span>
<a id="__codelineno-5-14" name="__codelineno-5-14"></a>
<a id="__codelineno-5-15" name="__codelineno-5-15"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                   </span><span class="c1">// - exit section</span>
<a id="__codelineno-5-16" name="__codelineno-5-16"></a>
<a id="__codelineno-5-17" name="__codelineno-5-17"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                  </span><span class="c1">// - remainder section</span>
<a id="__codelineno-5-18" name="__codelineno-5-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<div class="admonition property">
<p class="admonition-title">lemma</p>
<p>如果此时 i 和 j 同处于第 7 行，那么显然：</p>
<ol>
<li>两个进程都想要进入 critical section，即 <code>READY[i]</code> 和 <code>READY[j]</code> 都为 <code class="highlight"><span class="nb">true</span></code>；</li>
<li><code>TURN</code> 的值不再会被更改；</li>
<li>两个进程都尚未进入 critical section；</li>
</ol>
<p>由于 <code>TURN</code> 必定也只能为 i 或 j，所以 i 和 j 必然有且仅有一个进程接下来会 break loop 并进入 critical section，在它结束之前，即在 <code>READY[?]</code> 被改变之前，该条件持续成立。</p>
<p>因此我们得到一个结论：<u>如果此时 i 和 j 同处于第七行</u>，i 和 j 只有一个能进入 critical section；另外一个只有在先进去的那个释放资源了以后才能进去，所以满足互斥的条件。</p>
</div>
<p>现在我们考虑 i 已经先行运行到第 7 行，而 j 还没运行到第 7 行：</p>
<div class="admonition section">
<p class="admonition-title">Situation 1</p>
<p>如果 j 还没进入第 5 行，那么 <code>READY[j]</code> 为 <code class="highlight"><span class="nb">false</span></code>，此时没有竞争，i 可以直接进入临界态。并且 j 之后运行到第 7 行时，<code>TURN == &lt;another&gt;</code> 始终成立。所以 j 何时进入 critical section 完全取决于 <code>READY[j]</code>，即 j 何时离开 critical section。</p>
<p>显然，此时满足互斥性质。</p>
</div>
<div class="admonition section">
<p class="admonition-title">Situation 2</p>
<p>如果 j 已经运行完第 5 行，还没执行第 6 行，那么对于 i 来说，<code class="highlight"><span class="p">(</span><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span></code> 为 <code class="highlight"><span class="nb">true</span></code>，此时 i 将等待 j，进入 Situation 3。</p>
</div>
<p>也就是说，要么 i 和 j 不竞争，要么两者都运行到第 7 行后才会有进程进入 critical section</p>
<blockquote>
<p>这就好像两者在第 6 行比谁先举手，然后等两者都举过手（都跑完第 6 行，到达第 7 行）后，再判断谁进入 critical section，而进入第 7 行以后所有的判断条件都是相对静止的、不会再被修改的，因而避免甚至利用了 race condition 对 selection 的影响，保证了互斥的性质。</p>
</blockquote>
</details>
<details class="proof">
<summary>progress</summary>
<p>这条性质的成立比较符合直觉，唯一需要说明的就是不会出现两个进程同时在 <code>while ()</code> 被阻塞住的情况。但是这点非常显然，<code class="highlight"><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">i</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span></code> 必然是 false，所以两个循环总有一个会被 break。</p>
</details>
<details class="proof">
<summary>bounded waiting time</summary>
<p>在 Peterson's 中，等待时间主要指这部分的运行时间，尤其指第七行的 <code>while</code> 循环。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-6-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-6-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-6-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-6-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-6-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-6-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-6-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-6-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-6-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-6-10">10</a></span>
<span class="normal"><a href="#__codelineno-6-11">11</a></span>
<span class="normal"><a href="#__codelineno-6-12">12</a></span>
<span class="normal"><a href="#__codelineno-6-13">13</a></span>
<span class="normal"><a href="#__codelineno-6-14">14</a></span>
<span class="normal"><a href="#__codelineno-6-15">15</a></span>
<span class="normal"><a href="#__codelineno-6-16">16</a></span>
<span class="normal"><a href="#__codelineno-6-17">17</a></span>
<span class="normal"><a href="#__codelineno-6-18">18</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-6-1" name="__codelineno-6-1"></a><span class="c1">// `i` is 0 or 1, indicating current pid, while `j` is another pid.</span>
<a id="__codelineno-6-2" name="__codelineno-6-2"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-6-3" name="__codelineno-6-3"></a><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-6-4" name="__codelineno-6-4"></a>
<a id="__codelineno-6-5" name="__codelineno-6-5"></a><span class="hll"><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">                    </span><span class="c1">// ┐</span>
</span><a id="__codelineno-6-6" name="__codelineno-6-6"></a><span class="hll"><span class="w">    </span><span class="n">TURN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w">                           </span><span class="c1">// │</span>
</span><a id="__codelineno-6-7" name="__codelineno-6-7"></a><span class="hll"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="c1">// ├ entry section</span>
</span><a id="__codelineno-6-8" name="__codelineno-6-8"></a><span class="w">        </span><span class="c1">// i.e. wait until:             // │</span>
<a id="__codelineno-6-9" name="__codelineno-6-9"></a><span class="w">        </span><span class="c1">//  (1) j exits,                // │</span>
<a id="__codelineno-6-10" name="__codelineno-6-10"></a><span class="w">        </span><span class="c1">//  (2) j is slower, so it      // │</span>
<a id="__codelineno-6-11" name="__codelineno-6-11"></a><span class="w">        </span><span class="c1">//      should run now.         // ┘</span>
<a id="__codelineno-6-12" name="__codelineno-6-12"></a>
<a id="__codelineno-6-13" name="__codelineno-6-13"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">    </span><span class="c1">// - critical section</span>
<a id="__codelineno-6-14" name="__codelineno-6-14"></a>
<a id="__codelineno-6-15" name="__codelineno-6-15"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                   </span><span class="c1">// - exit section</span>
<a id="__codelineno-6-16" name="__codelineno-6-16"></a>
<a id="__codelineno-6-17" name="__codelineno-6-17"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                  </span><span class="c1">// - remainder section</span>
<a id="__codelineno-6-18" name="__codelineno-6-18"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>我们可以发现，不断循环的条件是：<code class="highlight"><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span></code>，如果该循环一开始就不成立，那么显然是符合 bounded waiting time 的，所以我们考虑这个条件最多能持续多久。</p>
<div class="admonition section">
<p class="admonition-title">A. <code class="highlight"><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></code> 为 <code class="highlight"><span class="nb">true</span></code></p>
<p>这需要 process j 已经运行过第 5 行，并且还没运行第 15 行，即 process j 也<strong>想要</strong>进入临界态。</p>
<p>这一条是在判断是否有冲突存在，如果现在只有 process i 想要进入临界态，那无需等待直接进入即可。通过<strong>改变这个条件</strong>而进入临界态有两种可能：</p>
<ol>
<li>一开始冲突就不存在；</li>
<li>process j 刚离开临界态，释放了临界资源；</li>
</ol>
</div>
<div class="admonition section">
<p class="admonition-title">B. <code class="highlight"><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span></code> 为 <code class="highlight"><span class="nb">true</span></code></p>
<p>有两种可能：</p>
<ol>
<li>process j 还没运行第 6 行；</li>
<li>process j 在 process i 之前就运行了第 6 行；</li>
</ol>
<p>对于第一种情况，由于 A. 成立后才会判断这条，所以 process j 的状态其实是刚运行完第 5 行还没运行完第 6 行，显然这个时间是有界的。</p>
<p>而对于第二种情况，说明 i 是后来者，j 已经客气过一次了，所以应当让 j 运行，i 等待 j 离开临界态释放资源，此时通过 A.2. 来进入临界态。而 process j 操作临界资源的时间也应当有限的。</p>
</div>
<p>综上所述，waiting time 的最大值基本上取自：</p>
<ol>
<li>process j 执行第 6 行的时间；</li>
<li>process j 操作临界资源的时间；</li>
</ol>
<p>通过之前的论述我们知道，这两个都是有界的，于是该性质得证。</p>
</details>
<div class="admonition bug">
<p class="admonition-title">Oops!</p>
<p>但是，<strong>Peterson's 实际上无法适用于现代计算机中</strong>。上述做法有一个关键，也是我们在证明过程中一直默认成立的事情：进程总是先执行 <code>READY[i] = true;</code>，然后才会执行 <code>TURN = j;</code>，即先进入就绪态，再索取临界资源，这看起来是个非常合理的条件。但在现代计算机中，编译器可能会通过重排列部分语句来更好地利用 CPU 资源（参考计组的<a href="https://xuan-insr.github.io/computer_organization/4_processor/#422-structure-hazards" target="_blank">各种竞争</a>）。而<strong>对编译器来说</strong>，这两个操作（就绪和请求）并没有操作相同内容，因而交换顺序是不会影响结果的，所以可能被编译器交换。而这就有可能导致出现问题，例如：</p>
<p><figure markdown>
<center> <img alt="" src="../img/23.png" /> </center>
The effects of instruction reordering in Peterson’s solution.
</figure></p>
<p>在棕色标记时刻，process 1 进行 <code>while</code> 循环判断，发现 <code>READY[0]</code> 为 <code class="highlight"><span class="nb">false</span></code>，但此时 <code>TURN</code> 指向对方，所以按照我们先前的分析，此时 process 1 会认为 process 0 是已经运行完 critical section，已经释放了临界资源，所以进入临界态；然而，在绿色标记时刻，对于 process 0，此时 <code>TURN</code> 指向自己，process 1 还没运行完所以 <code>READY[1]</code> 还是 <code class="highlight"><span class="nb">true</span></code>，根据我们之前的分析，此时 process 0 会认为 process 1 在等待自己，所以也进入了临界态。于是，两个进程同时进入了临界态，违反了 mutual exclusion 的性质。</p>
</div>
<p>所以，实际上 Peterson's Algorithm 仍然没有解决问题。</p>
<h2 id="memory-barriers">Memory Barriers</h2>
<p>该方法实际上是对上述软件方法的补足。我们先前提到，Peterson's Algorithm 失效的原因是编译器会根据需求重排列一些内存操作，而 memory barriers 保证 barrier 之前的 S/L 指令必须在 barrier 之后的 S/L 指令之前完成，使我们能够主动禁止编译器做这种重排。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-7-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-7-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-7-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-7-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-7-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-7-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-7-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-7-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-7-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-7-10">10</a></span>
<span class="normal"><a href="#__codelineno-7-11">11</a></span>
<span class="normal"><a href="#__codelineno-7-12">12</a></span>
<span class="normal"><a href="#__codelineno-7-13">13</a></span>
<span class="normal"><a href="#__codelineno-7-14">14</a></span>
<span class="normal"><a href="#__codelineno-7-15">15</a></span>
<span class="normal"><a href="#__codelineno-7-16">16</a></span>
<span class="normal"><a href="#__codelineno-7-17">17</a></span>
<span class="normal"><a href="#__codelineno-7-18">18</a></span>
<span class="normal"><a href="#__codelineno-7-19">19</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-7-1" name="__codelineno-7-1"></a><span class="c1">// `i` is 0 or 1, indicating current pid, while `j` is another pid.</span>
<a id="__codelineno-7-2" name="__codelineno-7-2"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-7-3" name="__codelineno-7-3"></a><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">1</span><span class="w"> </span><span class="o">-</span><span class="w"> </span><span class="n">i</span><span class="p">;</span>
<a id="__codelineno-7-4" name="__codelineno-7-4"></a>
<a id="__codelineno-7-5" name="__codelineno-7-5"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">                    </span><span class="c1">// ┐</span>
<a id="__codelineno-7-6" name="__codelineno-7-6"></a><span class="hll"><span class="w">    </span><span class="n">memory_barrier</span><span class="p">();</span><span class="w">                   </span><span class="c1">// │</span>
</span><a id="__codelineno-7-7" name="__codelineno-7-7"></a><span class="w">    </span><span class="n">TURN</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">j</span><span class="p">;</span><span class="w">                           </span><span class="c1">// │</span>
<a id="__codelineno-7-8" name="__codelineno-7-8"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">READY</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">TURN</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="c1">// ├ entry section</span>
<a id="__codelineno-7-9" name="__codelineno-7-9"></a><span class="w">        </span><span class="c1">// i.e. wait until:             // │</span>
<a id="__codelineno-7-10" name="__codelineno-7-10"></a><span class="w">        </span><span class="c1">//  (1) j exits,                // │</span>
<a id="__codelineno-7-11" name="__codelineno-7-11"></a><span class="w">        </span><span class="c1">//  (2) j is slower, so it      // │</span>
<a id="__codelineno-7-12" name="__codelineno-7-12"></a><span class="w">        </span><span class="c1">//      should run now.         // ┘</span>
<a id="__codelineno-7-13" name="__codelineno-7-13"></a>
<a id="__codelineno-7-14" name="__codelineno-7-14"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">    </span><span class="c1">// - critical section</span>
<a id="__codelineno-7-15" name="__codelineno-7-15"></a>
<a id="__codelineno-7-16" name="__codelineno-7-16"></a><span class="w">    </span><span class="n">READY</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                   </span><span class="c1">// - exit section</span>
<a id="__codelineno-7-17" name="__codelineno-7-17"></a>
<a id="__codelineno-7-18" name="__codelineno-7-18"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                  </span><span class="c1">// - remainder section</span>
<a id="__codelineno-7-19" name="__codelineno-7-19"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<hr />
<div class="admonition definition">
<p class="admonition-title">Memory Model</p>
<p>不同的计算机架构可能会对用户程序操作内存的保证有所不同，这种保证被称为 memory model。我们可以将它分为两大类：</p>
<ol>
<li>强有序(strongly ordered)：进程对内存做的修改立刻对其它处理器可见；</li>
<li>弱有序(weakly ordered)：进程对内存做的修改不立刻对其它处理器可见；</li>
</ol>
<p>我们知道，为了提高内存操作的效率，我们引入了 cache，在多处理器情况下，cache 机制的存在可能导致进程 A 对内存的写无法对进程 B 立刻可见，这就是弱有序的一种体现。</p>
<details class="extra" open="open">
<summary>补充材料</summary>
<p>感谢 <a href="https://github.com/27rabbitlt" target="_blank">ltgg</a> 提供的参考资料，读者有兴趣可以自行阅读：</p>
<ul>
<li><a href="https://preshing.com/20121019/this-is-why-they-call-it-a-weakly-ordered-cpu/" target="_blank">This Is Why They Call It a Weakly-Ordered CPU</a></li>
<li>⭐️ <a href="https://preshing.com/20120930/weak-vs-strong-memory-models/" target="_blank">Weak vs. Strong Memory Models</a></li>
</ul>
<blockquote>
<p>关于强弱的定义，大致的意思是：</p>
<p>A strong hardware memory model is one in which every machine instruction comes implicitly with acquire and release semantics. As a result, when one CPU core performs a sequence of writes, every other CPU core sees those values change in the same order that they were written.</p>
</blockquote>
</details>
</div>
<blockquote>
<p>这部分我没有完全搞清楚，书本的逻辑非常的诡异：书本认为 memory barrier 是弱有序问题的解决方案，但是我始终没明白它们之间的逻辑在哪里，以及“有序”和“立刻可见”的根本联系在哪里。这里一定是存在不清楚的地方的。但是这部分看起来不是很重要，所以我就先放着不管了。</p>
</blockquote>
<h2 id="hardware-instructions">Hardware Instructions</h2>
<p>讨论 Peterson's Algorithm 后我们应当意识到，同步问题的出现是 ⓵ 硬件操作数据需要时间，与 ⓶ 数据具有共享性的不协调，所以本质上是硬件产生的问题。因而，要想更好的解决问题，我们还是应当从硬件出发。我们在这里引入<strong>原子性(atomic)</strong>这个概念，它的基本逻辑是让“需要时间的，对数据的操作”，变成一个“在时间上不可分割、不可被打断的，即原子性的操作”。不同硬件可能提供不同的原子性操作，我们这里将它们抽象为 <code>test_and_set()</code> 和 <code>compare_and_swap()</code> 两类来介绍。</p>
<h3 id="test_and_set"><code>test_and_set()</code></h3>
<div class="admonition quote">
<p class="admonition-title">Links</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Test-and-set" target="_blank">Wikipedia</a></li>
</ul>
</div>
<div class="highlight"><pre><span></span><code><a id="__codelineno-8-1" name="__codelineno-8-1" href="#__codelineno-8-1"></a><span class="o">&lt;</span><span class="n">atomic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">test_and_set</span><span class="p">(</span><span class="kt">bool</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-8-2" name="__codelineno-8-2" href="#__codelineno-8-2"></a><span class="w">    </span><span class="kt">bool</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="p">;</span>
<a id="__codelineno-8-3" name="__codelineno-8-3" href="#__codelineno-8-3"></a><span class="w">    </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-8-4" name="__codelineno-8-4" href="#__codelineno-8-4"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-8-5" name="__codelineno-8-5" href="#__codelineno-8-5"></a><span class="p">}</span>
</code></pre></div>
<p>该指令的功能就类似上面这段代码：将目标设为 <code class="highlight"><span class="nb">true</span></code>，同时返回其旧值。但除此之外，这个指令需要保证<strong>原子性</strong>，即如果有若干 <code>test_and_set()</code> 同时发生，那么无论并发还是并行，它们都应当一个一个地执行，而不能产生时间上的交集。</p>
<p>可以发现，这种 atomic 的操作天然保证了 mutual exclusion，因而对于实现了 <code>test_and_set()</code> 的机器，我们可以使用 <code>test_and_set()</code> 来解决 CS 问题。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-9-1">1</a></span>
<span class="normal"><a href="#__codelineno-9-2">2</a></span>
<span class="normal"><a href="#__codelineno-9-3">3</a></span>
<span class="normal"><a href="#__codelineno-9-4">4</a></span>
<span class="normal"><a href="#__codelineno-9-5">5</a></span>
<span class="normal"><a href="#__codelineno-9-6">6</a></span>
<span class="normal"><a href="#__codelineno-9-7">7</a></span>
<span class="normal"><a href="#__codelineno-9-8">8</a></span>
<span class="normal"><a href="#__codelineno-9-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-9-1" name="__codelineno-9-1"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-9-2" name="__codelineno-9-2"></a><span class="hll"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="c1">// - entry section</span>
</span><a id="__codelineno-9-3" name="__codelineno-9-3"></a>
<a id="__codelineno-9-4" name="__codelineno-9-4"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">    </span><span class="c1">// - critical section</span>
<a id="__codelineno-9-5" name="__codelineno-9-5"></a>
<a id="__codelineno-9-6" name="__codelineno-9-6"></a><span class="w">    </span><span class="n">LOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                       </span><span class="c1">// - exit section</span>
<a id="__codelineno-9-7" name="__codelineno-9-7"></a>
<a id="__codelineno-9-8" name="__codelineno-9-8"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                  </span><span class="c1">// - remainder section</span>
<a id="__codelineno-9-9" name="__codelineno-9-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>在第 3 行，循环等待的条件变为 <code class="highlight"><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK</span><span class="p">)</span></code>，如果 <code>LOCK</code> 的旧值是 <code class="highlight"><span class="nb">false</span></code>，则可以继续，并且此时 <code>LOCK</code> 的值被原子性地修改为 <code class="highlight"><span class="nb">true</span></code>；而如果 <code>LOCK</code> 的旧值是 <code class="highlight"><span class="nb">true</span></code>，那么它经过 <code class="highlight"><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK</span><span class="p">)</span></code> 后的值仍然是 <code class="highlight"><span class="nb">true</span></code>，且需要等待，直到：将 <code>LOCK</code> 改成 <code class="highlight"><span class="nb">true</span></code> 的那个进程在 exit section 将 <code>LOCK</code> 改回 <code class="highlight"><span class="nb">false</span></code>，即释放锁。</p>
<p>但是请注意，与我们讨论 Peterson's Algorithm 时的语境不同，我们现在不再假设参与竞争的进程只有两个（这是 Peterson's 的局限性之一）。在这个语境下，我们再来考虑它是否满足<a href="#r4s2csp" target="_blank">三条性质</a>。</p>
<div class="admonition proof">
<p class="admonition-title">mutual exclusion</p>
<p>由于 <code class="highlight"><span class="n">test_and_set</span><span class="p">()</span></code> 是原子性的，所以同时执行的一系列 <code class="highlight"><span class="n">test_and_set</span><span class="p">()</span></code> 中，只有一个能返回 <code class="highlight"><span class="nb">false</span></code>，即只有一个能通过锁，因而天生满足了 mutual exclusion。</p>
</div>
<div class="admonition proof">
<p class="admonition-title">progress</p>
<p>代码中对 <code>LOCK</code> 的修改操作是闭合的，即进入 critical section 会导致 <code>LOCK</code> 变为 <code class="highlight"><span class="nb">false</span></code>，但离开 critical section 必定导致 <code>LOCK</code> 变为 <code class="highlight"><span class="nb">true</span></code>。因此，只要没有进程处于 critical section，那么 <code>LOCK</code> 必定为 <code class="highlight"><span class="nb">false</span></code>，则一定有就绪的进程能够进入 critical section，而运行 critical section 的时间是有限的，因此 <code>LOCK</code> 又一定会在有限时间内变为 <code class="highlight"><span class="nb">false</span></code>，从而满足 progress。</p>
</div>
<div class="admonition bug">
<p class="admonition-title">bounded waiting time</p>
<p>如果只有两个进程参与竞争，那么通过类似证明 progress 的过程可以得到 bounded waiting time 是可以成立的。A 离开临界态后处于就绪态等待的 B 立刻就能进入 critical section，即只有两个人排队是不会被插队的。</p>
<p>但在参与竞争的进程变多以后，就很有可能出现类似于调度中“饥饿”的现象：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-10-1" name="__codelineno-10-1" href="#__codelineno-10-1"></a>    ┌────┐      ┌────┐      ┌────┐      ┌────┐      
<a id="__codelineno-10-2" name="__codelineno-10-2" href="#__codelineno-10-2"></a>P0  │ CS │   ───┤ CS │   ───┤ CS │   ───┤ CS │   ─── ···
<a id="__codelineno-10-3" name="__codelineno-10-3" href="#__codelineno-10-3"></a>    └────┘      └────┘      └────┘      └────┘      
<a id="__codelineno-10-4" name="__codelineno-10-4" href="#__codelineno-10-4"></a>          ┌────┐      ┌────┐      ┌────┐      ┌────┐
<a id="__codelineno-10-5" name="__codelineno-10-5" href="#__codelineno-10-5"></a>P1  ──────┤ CS │   ───┤ CS │   ───┤ CS │   ───┤ CS │ ···
<a id="__codelineno-10-6" name="__codelineno-10-6" href="#__codelineno-10-6"></a>          └────┘      └────┘      └────┘      └────┘
<a id="__codelineno-10-7" name="__codelineno-10-7" href="#__codelineno-10-7"></a>
<a id="__codelineno-10-8" name="__codelineno-10-8" href="#__codelineno-10-8"></a>P2  ──────────────────────────────────────────────── ···
</code></pre></div>
<p>可以发现，由于 <code>P0</code> 和 <code>P1</code> 总是轮流获得锁，导致 <code>P2</code> 始终处于就绪态等待锁，因而对于 <code>P2</code> 来说 waiting time 就不再有限了。</p>
</div>
<p>糟了，看起来很酷的一个方法貌似不能满足 CS 解法的性质，但仔细分析，这是由于锁的分配机制是不可控的——在一个锁被释放后，接下来将拿到锁的进程应当是接下来第一个实际执行 <code>test_and_set()</code> 的进程，然而由于 ⓵ 我们对每个进程的运行速度，不应当有假设，⓶ 我们对同时产生的 <code>test_and_set()</code> 将按何顺序被处理，不应当有假设，所以我们必须手动用某种方法来实现这种“锁的调度”：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-11-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-11-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-11-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-11-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-11-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-11-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-11-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-11-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-11-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-11-10">10</a></span>
<span class="normal"><a href="#__codelineno-11-11">11</a></span>
<span class="normal"><a href="#__codelineno-11-12">12</a></span>
<span class="normal"><a href="#__codelineno-11-13">13</a></span>
<span class="normal"><a href="#__codelineno-11-14">14</a></span>
<span class="normal"><a href="#__codelineno-11-15">15</a></span>
<span class="normal"><a href="#__codelineno-11-16">16</a></span>
<span class="normal"><a href="#__codelineno-11-17">17</a></span>
<span class="normal"><a href="#__codelineno-11-18">18</a></span>
<span class="normal"><a href="#__codelineno-11-19">19</a></span>
<span class="normal"><a href="#__codelineno-11-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-11-1" name="__codelineno-11-1"></a><span class="c1">// `i` is process id in [0, n), where `n` is the count of related process. </span>
<a id="__codelineno-11-2" name="__codelineno-11-2"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-11-3" name="__codelineno-11-3"></a><span class="w">    </span><span class="n">WAITING</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span><span class="w">                                  </span><span class="c1">// ┐</span>
<a id="__codelineno-11-4" name="__codelineno-11-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">WAITING</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">      </span><span class="c1">// ├ entry sec.</span>
<a id="__codelineno-11-5" name="__codelineno-11-5"></a><span class="w">                                                        </span><span class="c1">// │</span>
<a id="__codelineno-11-6" name="__codelineno-11-6"></a><span class="w">    </span><span class="n">WAITING</span><span class="p">[</span><span class="n">i</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                                 </span><span class="c1">// ┘</span>
<a id="__codelineno-11-7" name="__codelineno-11-7"></a>
<a id="__codelineno-11-8" name="__codelineno-11-8"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">                    </span><span class="c1">// - critical sec.</span>
<a id="__codelineno-11-9" name="__codelineno-11-9"></a>
<a id="__codelineno-11-10" name="__codelineno-11-10"></a><span class="w">    </span><span class="c1">// i.e. find next waiting process j                 // ┐</span>
<a id="__codelineno-11-11" name="__codelineno-11-11"></a><span class="w">    </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">                                    </span><span class="c1">// │</span>
<a id="__codelineno-11-12" name="__codelineno-11-12"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">j</span><span class="w"> </span><span class="o">&amp;&amp;</span><span class="w"> </span><span class="o">!</span><span class="n">WAITING</span><span class="p">[</span><span class="n">j</span><span class="p">])</span><span class="w"> </span><span class="p">{</span><span class="w">                     </span><span class="c1">// ├ exit sec.</span>
<a id="__codelineno-11-13" name="__codelineno-11-13"></a><span class="w">        </span><span class="n">j</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="p">(</span><span class="n">j</span><span class="w"> </span><span class="o">+</span><span class="w"> </span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="o">%</span><span class="w"> </span><span class="n">n</span><span class="p">;</span><span class="w">                                </span><span class="c1">// │</span>
<a id="__codelineno-11-14" name="__codelineno-11-14"></a><span class="w">    </span><span class="p">}</span><span class="w">                                                   </span><span class="c1">// │</span>
<a id="__codelineno-11-15" name="__codelineno-11-15"></a><span class="w">    </span><span class="c1">// release j&#39;s LOCK or release whole LOCK           // │</span>
<a id="__codelineno-11-16" name="__codelineno-11-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">i</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">j</span><span class="p">)</span><span class="w">     </span><span class="n">LOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                       </span><span class="c1">// │</span>
<a id="__codelineno-11-17" name="__codelineno-11-17"></a><span class="w">    </span><span class="k">else</span><span class="w">            </span><span class="n">WAITING</span><span class="p">[</span><span class="n">j</span><span class="p">]</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                 </span><span class="c1">// ┘</span>
<a id="__codelineno-11-18" name="__codelineno-11-18"></a>
<a id="__codelineno-11-19" name="__codelineno-11-19"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                                  </span><span class="c1">// - remainder sec.</span>
<a id="__codelineno-11-20" name="__codelineno-11-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>我们引入了一个 <code class="highlight"><span class="n">WAITING</span><span class="p">[]</span></code> 数组来辅助 <code>LOCK</code> 细化锁的粒度，此时 <code>LOCK</code> 表示的“是否存在竞争”，而 <code class="highlight"><span class="n">WAITING</span><span class="p">[]</span></code> 则标识了所有正在等待的进程。区别于之前直接释放整个锁，让剩下的进程去“拼手速”，我们这次由释放锁的进程来选择下一个进入 critical section 的是谁。</p>
<p>在 11-14 行，通过一个循环找到下一个 <code class="highlight"><span class="n">WAITING</span><span class="p">[</span><span class="n">j</span><span class="p">]</span></code> 为 <code class="highlight"><span class="nb">true</span></code> 的 j，⓵ 如果找到了这个 j，那么就将 <code>WAITING[j]</code> 设为 <code class="highlight"><span class="nb">false</span></code>（19 行），这样 j 马上就会在第 4 行 break，进入 critical section；⓶ 而如果找不到这个 j，即找了一圈又找回了 i，那么说明 i 是最后一个了，所以可以直接释放整个锁（17 行）。</p>
<p>通过使用这种方法，我们保证了等待中的进程最多只需要等待 n-1 个进程运行完 critical section（类似于实现了“FCFS”）。</p>
<h3 id="compare_and_swap"><code>compare_and_swap()</code></h3>
<div class="admonition quote">
<p class="admonition-title">Links</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Compare-and-swap">Wikipedia</a></li>
</ul>
</div>
<p><code>compare_and_swap()</code> 也被简写为 CAS 指令，它的功能如下：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-12-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-12-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-12-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-12-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-12-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-12-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-12-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-12-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-12-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-12-10">10</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-12-1" name="__codelineno-12-1"></a><span class="o">&lt;</span><span class="n">atomic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">compare_and_swap</span><span class="p">(</span><span class="kt">int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">expected</span><span class="p">,</span><span class="w"> </span><span class="kt">int</span><span class="w"> </span><span class="n">new_val</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-2" name="__codelineno-12-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">ret</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">target</span><span class="p">;</span>
<a id="__codelineno-12-3" name="__codelineno-12-3"></a>
<a id="__codelineno-12-4" name="__codelineno-12-4"></a><span class="w">    </span><span class="c1">// *target = (*target == expected) ? new_val : *target;</span>
<a id="__codelineno-12-5" name="__codelineno-12-5"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">==</span><span class="w"> </span><span class="n">expected</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-12-6" name="__codelineno-12-6"></a><span class="w">        </span><span class="o">*</span><span class="n">target</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">new_val</span><span class="p">;</span>
<a id="__codelineno-12-7" name="__codelineno-12-7"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-12-8" name="__codelineno-12-8"></a>
<a id="__codelineno-12-9" name="__codelineno-12-9"></a><span class="w">    </span><span class="k">return</span><span class="w"> </span><span class="n">ret</span><span class="p">;</span>
<a id="__codelineno-12-10" name="__codelineno-12-10"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>CAS 接受三个值：</p>
<ol>
<li><code>target</code> 待修改的数据的地址；</li>
<li><code>expected</code> 预期中待修改的数据的旧值；</li>
<li><code>new_val</code> 希望将数据修改为的新值；</li>
</ol>
<p>而当且仅当 <code>*target</code> 符合预期，与 <code>expected</code> 相同时候，才会将它改为 <code>new_val</code>。同样，CAS 也应当保证原子性，即若干 CAS 同时发生时，也应当一个一个的执行，而不能存在时间上的交集。</p>
<p>我们注意到，实际上 <code class="highlight"><span class="n">test_and_set</span><span class="p">(</span><span class="n">target</span><span class="p">)</span></code> 就是 <code class="highlight"><span class="n">compare_and_swap</span><span class="p">(</span><span class="n">target</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">)</span></code>，因而实际上 CAS 解决 CS 问题的方法以及问题和上一节的内容没什么差别。</p>
<p>但是我们发现，<code>compare_and_swap()</code> 相比于 <code>test_and_set()</code>，显然有更大的操作空间，也更泛用，考虑到 CAS 指令自身已经能够支持原子性的修改值，我们考虑能否跳出 CS 问题的范式来考虑问题。</p>
<h2 id="atomic-variables">Atomic Variables</h2>
<p><strong>原子变量(atomic variables)</strong>是一种用原子性操作维护的变量。我们所有对原子变量的操作可以通过 CAS 来实现，例如自增操作：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-13-1" name="__codelineno-13-1" href="#__codelineno-13-1"></a><span class="n">increment</span><span class="p">(</span><span class="kt">atomic_int</span><span class="w"> </span><span class="o">*</span><span class="w"> </span><span class="n">v</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-2" name="__codelineno-13-2" href="#__codelineno-13-2"></a><span class="w">    </span><span class="kt">int</span><span class="w"> </span><span class="n">tmp</span><span class="p">;</span>
<a id="__codelineno-13-3" name="__codelineno-13-3" href="#__codelineno-13-3"></a><span class="w">    </span><span class="k">do</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-13-4" name="__codelineno-13-4" href="#__codelineno-13-4"></a><span class="w">        </span><span class="n">tmp</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="o">*</span><span class="n">v</span><span class="p">;</span>
<a id="__codelineno-13-5" name="__codelineno-13-5" href="#__codelineno-13-5"></a><span class="w">    </span><span class="p">}</span><span class="w"> </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">tmp</span><span class="w"> </span><span class="o">!=</span><span class="w"> </span><span class="n">compare_and_swap</span><span class="p">(</span><span class="n">v</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="p">,</span><span class="w"> </span><span class="n">tmp</span><span class="o">+</span><span class="mi">1</span><span class="p">)</span><span class="w"> </span><span class="p">);</span>
<a id="__codelineno-13-6" name="__codelineno-13-6" href="#__codelineno-13-6"></a><span class="p">}</span>
</code></pre></div>
<p>使用 atomic variables 后实际上就<strong>不太符合 CS 问题的模型</strong>了，可以发现，这里并不再需要维护类似 <code>LOCK</code> 的东西，而是以 <code>*target</code> 是否符合 <code>expected</code> 的预设来判断是否有竞争出现，作为一个同步工具，我们可以直接使用这种封装后的原子性操作来解决 race condition，而不需要再区分 entry section 或是 critical section 等。</p>
<blockquote>
<p>书本上特地提到，在例如 <a href="../Unit2-Part2/#the-bounded-buffer-problem" target="_blank">producer&amp;consumer</a> 的模型中，使用 atomic variables 维护 count 并不能解决 race condition，但我认为这种讨论是有失偏颇的，所谓的“原子性”应该包括所有操作临界资源的部分，书中只维护 count 不维护 buffer 的假设我觉得对于 atomic 这个概念来说实在不够公平，所以我在这里就不着重说明这个问题。</p>
</blockquote>
<h2 id="mutex-locks">Mutex Locks</h2>
<p>由此我们已经得到了能在硬件层面解决 race condition 问题的根源的工具了，但是为了能让用户程序也能更好的使用，我们需要将它做一次软件层面的封装。于是，我们设计了<strong>互斥锁(mutex locks)</strong>这个东西。</p>
<p>利用互斥锁避免 race condition 的基本思路仍然是基于 CS 问题的建模，但它更具体地认为在 entry section 就该去索取互斥锁，而在 exit section 就应该去释放互斥锁，即：</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-14-1" name="__codelineno-14-1" href="#__codelineno-14-1"></a>┌─────────────────────┐
<a id="__codelineno-14-2" name="__codelineno-14-2" href="#__codelineno-14-2"></a>│  Acquire Lock       │
<a id="__codelineno-14-3" name="__codelineno-14-3" href="#__codelineno-14-3"></a>├─────────────────────┤
<a id="__codelineno-14-4" name="__codelineno-14-4" href="#__codelineno-14-4"></a>│  Critical Section   │ &lt;-- codes manipulating critical resources
<a id="__codelineno-14-5" name="__codelineno-14-5" href="#__codelineno-14-5"></a>├─────────────────────┤
<a id="__codelineno-14-6" name="__codelineno-14-6" href="#__codelineno-14-6"></a>│  Release Lock       │
<a id="__codelineno-14-7" name="__codelineno-14-7" href="#__codelineno-14-7"></a>├─────────────────────┤
<a id="__codelineno-14-8" name="__codelineno-14-8" href="#__codelineno-14-8"></a>│  Remainder Section  │ &lt;-- other codes
<a id="__codelineno-14-9" name="__codelineno-14-9" href="#__codelineno-14-9"></a>└─────────────────────┘
</code></pre></div>
<p>回顾我们在介绍 <a href="#test_and_set" target="_blank"><code>test_and_set()</code></a> 部分给出的这段代码：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-15-1">1</a></span>
<span class="normal"><a href="#__codelineno-15-2">2</a></span>
<span class="normal"><a href="#__codelineno-15-3">3</a></span>
<span class="normal"><a href="#__codelineno-15-4">4</a></span>
<span class="normal"><a href="#__codelineno-15-5">5</a></span>
<span class="normal"><a href="#__codelineno-15-6">6</a></span>
<span class="normal"><a href="#__codelineno-15-7">7</a></span>
<span class="normal"><a href="#__codelineno-15-8">8</a></span>
<span class="normal"><a href="#__codelineno-15-9">9</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-15-1" name="__codelineno-15-1"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-15-2" name="__codelineno-15-2"></a><span class="hll"><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="n">test_and_set</span><span class="p">(</span><span class="o">&amp;</span><span class="n">LOCK</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w">    </span><span class="c1">// - entry section</span>
</span><a id="__codelineno-15-3" name="__codelineno-15-3"></a>
<a id="__codelineno-15-4" name="__codelineno-15-4"></a><span class="w">    </span><span class="cm">/* operate critical resources */</span><span class="w">    </span><span class="c1">// - critical section</span>
<a id="__codelineno-15-5" name="__codelineno-15-5"></a>
<a id="__codelineno-15-6" name="__codelineno-15-6"></a><span class="hll"><span class="w">    </span><span class="n">LOCK</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">false</span><span class="p">;</span><span class="w">                       </span><span class="c1">// - exit section</span>
</span><a id="__codelineno-15-7" name="__codelineno-15-7"></a>
<a id="__codelineno-15-8" name="__codelineno-15-8"></a><span class="w">    </span><span class="cm">/* other things */</span><span class="w">                  </span><span class="c1">// - remainder section</span>
<a id="__codelineno-15-9" name="__codelineno-15-9"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>我们只需要将高亮的这两行封装起来，就实现了 acquire LOCK 和 release LOCK。</p>
<div class="highlight"><pre><span></span><code><a id="__codelineno-16-1" name="__codelineno-16-1" href="#__codelineno-16-1"></a><span class="c1">// `available` means whether the `LOCK` is free, or whether the related </span>
<a id="__codelineno-16-2" name="__codelineno-16-2" href="#__codelineno-16-2"></a><span class="c1">// resources is available</span>
<a id="__codelineno-16-3" name="__codelineno-16-3" href="#__codelineno-16-3"></a><span class="n">acquire</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-4" name="__codelineno-16-4" href="#__codelineno-16-4"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="w"> </span><span class="o">!</span><span class="n">compare_and_swap</span><span class="p">(</span><span class="o">&amp;</span><span class="n">available</span><span class="p">,</span><span class="w"> </span><span class="nb">true</span><span class="p">,</span><span class="w"> </span><span class="nb">false</span><span class="p">)</span><span class="w"> </span><span class="p">)</span><span class="w"> </span><span class="p">{}</span>
<a id="__codelineno-16-5" name="__codelineno-16-5" href="#__codelineno-16-5"></a><span class="p">}</span>
<a id="__codelineno-16-6" name="__codelineno-16-6" href="#__codelineno-16-6"></a>
<a id="__codelineno-16-7" name="__codelineno-16-7" href="#__codelineno-16-7"></a><span class="n">release</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-16-8" name="__codelineno-16-8" href="#__codelineno-16-8"></a><span class="w">    </span><span class="n">available</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="nb">true</span><span class="p">;</span>
<a id="__codelineno-16-9" name="__codelineno-16-9" href="#__codelineno-16-9"></a><span class="p">}</span>
</code></pre></div>
<blockquote>
<p>你可能注意到了，我们在 <a href="#test_and_set" target="_blank"><code>test_and_set()</code></a> 讨论上面那段代码的时候，讨论过它无法满足 bounded waiting time 的问题，那既然如此我们为什么不把 <code>WAITING[]</code> 也一起封进去呢？</p>
<p>这是因为书上直接忽略了这个问题，直到在之后讲 <a href="#semaphores" target="_blank">semaphores</a> 的时候才想起来，但 semaphores 和 mutex lock 又是两个路子，我也不知道它到底想说明什么问题。但是既然它现在忽略了，我们就先不管它，但是我希望读者能意识到这个问题是存在的。</p>
</blockquote>
<p>经过这么长的铺垫，我们现在能够保证的一件事是，我们终于得到了一个软件层面的、能够避免 race condition 的同步工具。那么实现基本需求以后我们就开始考虑能不能优化它。</p>
<h3 id="_4">忙等待</h3>
<p>如果读者对代码有比较敏感的嗅觉，那可能看这几千个字到现在，你已经为数不清的 <code>while()</code> 提心吊胆过十多次了。没错，虽然我们通过逻辑保证这里不会出现死循环，但对于等待中的 process，确实要在数不尽的 <code>while</code> loop 中浪费 CPU，我们称这种等待锁释放的行为为<strong>忙等待(busy waiting)</strong>，其中“忙”指的就是在等待过程中仍然占用 CPU 资源。而这种使用忙等待的互斥锁，也被称为<strong><a href="https://en.wikipedia.org/wiki/Spinlock" target="_blank">自旋锁(spinlock)</a></strong>。</p>
<p>我们引入两个词来更准确的描述这件事：</p>
<div class="admonition definition">
<p class="admonition-title">Lock Contention</p>
<p>如果一个用户试图索取某个锁时，如果这个锁不是 available 的，这就意味着有用户正在使用这个锁，而当前用户需要等待这个锁重新可用，此时我们称这个锁是<strong>被争抢的(contended)</strong>；反之，如果不存在争抢，我们就称之为不被争抢的(uncontended)。</p>
<p>如果现在有好多用户都在争抢一个锁，我们称之为 high contention；反之如果只有零星几个用户在争抢这个锁，我们称之为 low contention。</p>
<p>如果延用 spinlock，那么不难得到结论：high contention 会导致严重的性能问题，因为总是会有大量得不到锁的用户处于 busy waiting 中。</p>
</div>
<p>既然它们都是在做无意义的等待，那我们为什么不在这个时候把资源让给有需要的人呢？</p>
<p>我们可以通过暂时地切换进程，让这些处于等待的用户暂时休眠，等时机到来再唤醒它们，此时就需要系统调用的介入[^3]。而具体的方法我们在下一节的<a href="#避免忙等待" target="_blank">避免忙等待</a>中介绍。</p>
<p><strong>但是</strong>请注意，我们在这里需要保持客观：spinlock 在特定情况下是有好处的，在等待时间并不长的情况下，相比于拥有锁的用户释放锁，进行调度锁需要的 context switch 的开销可能显得较大，在这种情况下我们还没来得及把资源让给别人锁就好了，那么这种资源转让还不如不转。而事实上，在特定情况下，自旋锁也确实是一些多核系统的首选。</p>
<p>不过在许多语境里 mutex 和 spinlock 是被区分开来的两个概念，具体使用哪个则需要适时判断[^4]。</p>
<h2 id="semaphores">Semaphores</h2>
<div class="admonition quote">
<p class="admonition-title">Links</p>
<ul>
<li><a href="https://en.wikipedia.org/wiki/Semaphore_(programming)" target="_blank">Wikipedia</a></li>
</ul>
</div>
<p>Mutex lock 为用户程序提供了类似于“房间申请”的功能，锁竞争就好像大家抢房间的使用权。而<strong>信号量(semaphores)</strong>则是类似于我们之前提到过的 <a href="#atomic-variables" target="_blank">atomic variables</a>，通过提供标准化的原子性操作，来维护一些变量，只不过它额外对变量的值有一定的约束。</p>
<p>~~（说实话我感觉这俩东西本质上真没啥区别……）~~</p>
<p>Semaphores 只提供两个标准化的接口：<code>wait()</code>（或<code>P()</code>） 和 <code>signal()</code>（或<code>V()</code>），它们的功能如下：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-17-1">1</a></span>
<span class="normal"><a href="#__codelineno-17-2">2</a></span>
<span class="normal"><a href="#__codelineno-17-3">3</a></span>
<span class="normal"><a href="#__codelineno-17-4">4</a></span>
<span class="normal"><a href="#__codelineno-17-5">5</a></span>
<span class="normal"><a href="#__codelineno-17-6">6</a></span>
<span class="normal"><a href="#__codelineno-17-7">7</a></span>
<span class="normal"><a href="#__codelineno-17-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-17-1" name="__codelineno-17-1"></a><span class="o">&lt;</span><span class="n">atomic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-2" name="__codelineno-17-2"></a><span class="w">    </span><span class="k">while</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{}</span><span class="w"> </span><span class="c1">// busy wait here</span>
<a id="__codelineno-17-3" name="__codelineno-17-3"></a><span class="w">    </span><span class="n">S</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-17-4" name="__codelineno-17-4"></a><span class="p">}</span>
<a id="__codelineno-17-5" name="__codelineno-17-5"></a>
<a id="__codelineno-17-6" name="__codelineno-17-6"></a><span class="o">&lt;</span><span class="n">atomic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">signal</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-17-7" name="__codelineno-17-7"></a><span class="w">    </span><span class="n">S</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-17-8" name="__codelineno-17-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>显然，这两个操作的实现也应当保证是 atomic 的。</p>
<p>区别于普通的 atomic variables，semaphores 多了在第 2 行的 busy wait，这暗含了一种“有限”的概念，即保证 <span class="arithmatex">\(0 \leq S\)</span>。在实际使用中，semaphores 分为 counting semaphore 和 binary semaphore，前者的功能如上，后者只不过是额外要求 <span class="arithmatex">\(0 \leq S \leq 1\)</span>，修改 loop 的条件即可。</p>
<h3 id="_5">使用</h3>
<p>例如，我们可以用如下方式，保证 <code>P0()</code> 中的 section A 必须在 <code>P1()</code> 的 section B 之前完成：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-18-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-18-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-18-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-18-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-18-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-18-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-18-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-18-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-18-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-18-10">10</a></span>
<span class="normal"><a href="#__codelineno-18-11">11</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-18-1" name="__codelineno-18-1"></a><span class="n">semaphore</span><span class="w"> </span><span class="n">S</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="mi">0</span><span class="p">;</span>
<a id="__codelineno-18-2" name="__codelineno-18-2"></a>
<a id="__codelineno-18-3" name="__codelineno-18-3"></a><span class="n">P0</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-4" name="__codelineno-18-4"></a><span class="w">    </span><span class="cm">/* Section A */</span>
<a id="__codelineno-18-5" name="__codelineno-18-5"></a><span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
<a id="__codelineno-18-6" name="__codelineno-18-6"></a><span class="p">}</span>
<a id="__codelineno-18-7" name="__codelineno-18-7"></a>
<a id="__codelineno-18-8" name="__codelineno-18-8"></a><span class="n">P1</span><span class="p">()</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-18-9" name="__codelineno-18-9"></a><span class="w">    </span><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">);</span>
<a id="__codelineno-18-10" name="__codelineno-18-10"></a><span class="w">    </span><span class="cm">/* Section B */</span>
<a id="__codelineno-18-11" name="__codelineno-18-11"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>上面的例子非常形象地展示了信号量是如何发挥作用的，当然，上面只展示了类似<strong>进程间通讯</strong>的功能，下面这个形式则更接近我们上文中讨论的情况，即实现了<strong>互斥</strong>：</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-19-1">1</a></span>
<span class="normal"><a href="#__codelineno-19-2">2</a></span>
<span class="normal"><a href="#__codelineno-19-3">3</a></span>
<span class="normal"><a href="#__codelineno-19-4">4</a></span>
<span class="normal"><a href="#__codelineno-19-5">5</a></span>
<span class="normal"><a href="#__codelineno-19-6">6</a></span>
<span class="normal"><a href="#__codelineno-19-7">7</a></span>
<span class="normal"><a href="#__codelineno-19-8">8</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-19-1" name="__codelineno-19-1"></a><span class="c1">// `i` is process id and S is the semaphores</span>
<a id="__codelineno-19-2" name="__codelineno-19-2"></a><span class="n">process</span><span class="p">(</span><span class="n">i</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-19-3" name="__codelineno-19-3"></a><span class="w">    </span><span class="n">wait</span><span class="p">(</span><span class="n">S</span><span class="p">);</span><span class="w">    </span><span class="c1">// i.e. release the &#39;LOCK&#39;</span>
<a id="__codelineno-19-4" name="__codelineno-19-4"></a>
<a id="__codelineno-19-5" name="__codelineno-19-5"></a><span class="w">    </span><span class="cm">/* critical section */</span>
<a id="__codelineno-19-6" name="__codelineno-19-6"></a>
<a id="__codelineno-19-7" name="__codelineno-19-7"></a><span class="w">    </span><span class="n">signal</span><span class="p">(</span><span class="n">S</span><span class="p">);</span><span class="w">  </span><span class="c1">// only one process can pass this line at once</span>
<a id="__codelineno-19-8" name="__codelineno-19-8"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<h3 id="_6">避免忙等待</h3>
<p>我们在 mutex 中提出<a href="#忙等待" target="_blank">忙等待</a>的时候就已经提到过，可以通过「在等待的时候让进程休眠，等时机合适的时候再唤醒」的方式，来减小<strong>较长的</strong>忙等待引起的性能降低。而为了实现这一点，我们需要扩展 semaphores 的内容，引入一个链表来维护等待中的进程。</p>
<div class="highlight"><table class="highlighttable"><tr><td class="linenos"><div class="linenodiv"><pre><span></span><span class="normal"><a href="#__codelineno-20-1"> 1</a></span>
<span class="normal"><a href="#__codelineno-20-2"> 2</a></span>
<span class="normal"><a href="#__codelineno-20-3"> 3</a></span>
<span class="normal"><a href="#__codelineno-20-4"> 4</a></span>
<span class="normal"><a href="#__codelineno-20-5"> 5</a></span>
<span class="normal"><a href="#__codelineno-20-6"> 6</a></span>
<span class="normal"><a href="#__codelineno-20-7"> 7</a></span>
<span class="normal"><a href="#__codelineno-20-8"> 8</a></span>
<span class="normal"><a href="#__codelineno-20-9"> 9</a></span>
<span class="normal"><a href="#__codelineno-20-10">10</a></span>
<span class="normal"><a href="#__codelineno-20-11">11</a></span>
<span class="normal"><a href="#__codelineno-20-12">12</a></span>
<span class="normal"><a href="#__codelineno-20-13">13</a></span>
<span class="normal"><a href="#__codelineno-20-14">14</a></span>
<span class="normal"><a href="#__codelineno-20-15">15</a></span>
<span class="normal"><a href="#__codelineno-20-16">16</a></span>
<span class="normal"><a href="#__codelineno-20-17">17</a></span>
<span class="normal"><a href="#__codelineno-20-18">18</a></span>
<span class="normal"><a href="#__codelineno-20-19">19</a></span>
<span class="normal"><a href="#__codelineno-20-20">20</a></span></pre></div></td><td class="code"><div><pre><span></span><code><a id="__codelineno-20-1" name="__codelineno-20-1"></a><span class="k">struct</span><span class="w"> </span><span class="nc">semaphore</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-2" name="__codelineno-20-2"></a><span class="w">    </span><span class="n">value</span><span class="p">;</span>
<a id="__codelineno-20-3" name="__codelineno-20-3"></a><span class="w">    </span><span class="n">waiting_list</span><span class="p">;</span>
<a id="__codelineno-20-4" name="__codelineno-20-4"></a><span class="p">};</span>
<a id="__codelineno-20-5" name="__codelineno-20-5"></a>
<a id="__codelineno-20-6" name="__codelineno-20-6"></a><span class="o">&lt;</span><span class="n">atomic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">wait</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-7" name="__codelineno-20-7"></a><span class="w">    </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">--</span><span class="p">;</span>
<a id="__codelineno-20-8" name="__codelineno-20-8"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-9" name="__codelineno-20-9"></a><span class="w">        </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">waiting_list</span><span class="p">.</span><span class="n">push</span><span class="p">(</span><span class="n">current</span><span class="w"> </span><span class="n">process</span><span class="p">);</span>
<a id="__codelineno-20-10" name="__codelineno-20-10"></a><span class="w">        </span><span class="n">sleep</span><span class="p">();</span>
<a id="__codelineno-20-11" name="__codelineno-20-11"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-12" name="__codelineno-20-12"></a><span class="p">}</span>
<a id="__codelineno-20-13" name="__codelineno-20-13"></a>
<a id="__codelineno-20-14" name="__codelineno-20-14"></a><span class="o">&lt;</span><span class="n">atomic</span><span class="o">&gt;</span><span class="w"> </span><span class="n">signal</span><span class="p">(</span><span class="n">reference</span><span class="w"> </span><span class="n">S</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-15" name="__codelineno-20-15"></a><span class="w">    </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">value</span><span class="o">++</span><span class="p">;</span>
<a id="__codelineno-20-16" name="__codelineno-20-16"></a><span class="w">    </span><span class="k">if</span><span class="w"> </span><span class="p">(</span><span class="n">S</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span><span class="p">)</span><span class="w"> </span><span class="p">{</span>
<a id="__codelineno-20-17" name="__codelineno-20-17"></a><span class="w">        </span><span class="n">p</span><span class="w"> </span><span class="o">=</span><span class="w"> </span><span class="n">S</span><span class="o">-&gt;</span><span class="n">waiting_list</span><span class="p">.</span><span class="n">pop</span><span class="p">();</span>
<a id="__codelineno-20-18" name="__codelineno-20-18"></a><span class="w">        </span><span class="n">wakeup</span><span class="p">(</span><span class="n">p</span><span class="p">);</span>
<a id="__codelineno-20-19" name="__codelineno-20-19"></a><span class="w">    </span><span class="p">}</span>
<a id="__codelineno-20-20" name="__codelineno-20-20"></a><span class="p">}</span>
</code></pre></div></td></tr></table></div>
<p>相比于之前的逻辑，现在的逻辑稍微有点变化，请读者尝试独立分析其中的奥秘。这里是一些提示：</p>
<div class="admonition tip">
<p class="admonition-title">头脑风暴</p>
<p>请读者思考：</p>
<ol>
<li>现在已经没有 <code>while</code> 了，只余下 <code>if</code>，现在是如何保证等待中的进程能够被及时唤醒？</li>
<li><code>wait</code> 原先是先等待再修改，现在是先修改、再等待，这对整体逻辑有何影响？</li>
<li><code>signal</code> 中的条件语句，为何是 <code class="highlight"><span class="n">S</span><span class="o">-&gt;</span><span class="n">value</span><span class="w"> </span><span class="o">&lt;=</span><span class="w"> </span><span class="mi">0</span></code>？这个条件为 false 时意味着什么？<ul>
<li>考虑在 high contention 的情况下，资源总是一出现就被抢空。</li>
</ul>
</li>
</ol>
</div>
<p>而实际上，现在我们提到信号量，默认指的就是<a href="#避免忙等待" target="_blank">避免忙等待</a>这一节中提到的这种。</p>
<p>[^1]: <a href="https://crystal.uta.edu/~ylei/cse6324/data/critical-section.pdf" target="_blank">The Critical Section Problem</a></p>
<p>[^2]: 书本中对 preemptive kernels 和 non-preemptive kernels 的定义并不准确，两者最本质的区别是后者实现了 <a href="https://en.wikipedia.org/wiki/Giant_LOCK" target="_blank">Giant Lock</a>。同时读者可以参考这个链接：<a href="https://unix.stackexchange.com/questions/412806/what-was-the-reason-of-the-non-preemptivity-of-older-linux-kernels" target="_blank">What was the reason of the non-preemptivity of older Linux kernels? | Stack Exchange</a></p>
<p>[^3]: <a href="https://stackoverflow.com/a/7068027/22331129" target="_blank">Mutex access and system call | Stack Overflow</a></p>
<p>[^4]: ⭐️ <a href="https://stackoverflow.com/a/5870415/22331129" target="_blank">When should one use a spinlock instead of mutex? | Stack Overflow</a></p>












                
              </article>
            </div>
          
          
<script>var target=document.getElementById(location.hash.slice(1));target&&target.name&&(target.checked=target.name.startsWith("__tabbed_"))</script>
        </div>
        
          <button type="button" class="md-top md-icon" data-md-component="top" hidden>
  
  <svg xmlns="http://www.w3.org/2000/svg" viewBox="0 0 24 24"><path d="M13 20h-2V8l-5.5 5.5-1.42-1.42L12 4.16l7.92 7.92-1.42 1.42L13 8v12Z"/></svg>
  Back to top
</button>
        
      </main>
      
        <footer class="md-footer">
  
  <div class="md-footer-meta md-typeset">
    <div class="md-footer-meta__inner md-grid">
      <div class="md-copyright">
  
  
    Made with
    <a href="https://squidfunk.github.io/mkdocs-material/" target="_blank" rel="noopener">
      Material for MkDocs
    </a>
  
</div>
      
    </div>
  </div>
</footer>
      
    </div>
    <div class="md-dialog" data-md-component="dialog">
      <div class="md-dialog__inner md-typeset"></div>
    </div>
    
    
    <script id="__config" type="application/json">{"base": "../..", "features": ["content.code.copy", "navigation.top", "navigation.sections"], "search": "../../assets/javascripts/workers/search.b8dbb3d2.min.js", "translations": {"clipboard.copied": "Copied to clipboard", "clipboard.copy": "Copy to clipboard", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.none": "No matching documents", "search.result.one": "1 matching document", "search.result.other": "# matching documents", "search.result.placeholder": "Type to start searching", "search.result.term.missing": "Missing", "select.version": "Select version"}}</script>
    
    
      <script src="../../assets/javascripts/bundle.fe8b6f2b.min.js"></script>
      
        <script src="https://polyfill.io/v3/polyfill.min.js?features=es6"></script>
      
        <script src="https://cdn.jsdelivr.net/npm/mathjax@3/es5/tex-mml-chtml.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/katex.min.js"></script>
      
        <script src="https://cdnjs.cloudflare.com/ajax/libs/KaTeX/0.16.7/contrib/auto-render.min.js"></script>
      
        <script src="../../stylesheets/Sakura.js"></script>
      
    
  </body>
</html>